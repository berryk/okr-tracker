AWSTemplateFormatVersion: '2010-09-09'
Description: 'OKR Tracker - Single instance deployment with ALB, Bedrock integration and S3 backups'

Parameters:
  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.small
      - t3.medium
      - t3.large
      - t3.xlarge
    Description: EC2 instance type

  BedrockModelId:
    Type: String
    Default: anthropic.claude-3-5-sonnet-20241022-v2:0
    Description: Bedrock model ID for Claude

  BackupRetentionDays:
    Type: Number
    Default: 30
    Description: Number of days to retain database backups in S3

Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-0c7217cdde317cfec
    us-west-2:
      AMI: ami-03f65b8614a860c29
    eu-west-1:
      AMI: ami-0905a3c97561e0b69
    eu-west-2:
      AMI: ami-0e8d228ad90af673b

Resources:
  # ============ S3 BACKUP BUCKET ============
  BackupBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Sub '${AWS::StackName}-backups-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldBackups
            Status: Enabled
            ExpirationInDays: !Ref BackupRetentionDays
          - Id: TransitionToIA
            Status: Enabled
            Transitions:
              - StorageClass: STANDARD_IA
                TransitionInDays: 7
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-backups'
        - Key: account_env
          Value: nprd
        - Key: lob_division
          Value: ma_cng
        - Key: application
          Value: okr-tracker
        - Key: environment
          Value: dev
        - Key: owner
          Value: keith.berry@moodys.com
        - Key: provisioned_by
          Value: berryk

  # ============ IAM ROLE ============
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:ListFoundationModels
                Resource: '*'
        - PolicyName: S3BackupAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:DeleteObject
                Resource:
                  - !GetAtt BackupBucket.Arn
                  - !Sub '${BackupBucket.Arn}/*'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-role'
        - Key: account_env
          Value: nprd
        - Key: lob_division
          Value: ma_cng
        - Key: application
          Value: okr-tracker
        - Key: environment
          Value: dev
        - Key: owner
          Value: keith.berry@moodys.com
        - Key: provisioned_by
          Value: berryk

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${AWS::StackName}-profile'
      Roles:
        - !Ref EC2Role

  # ============ SECURITY GROUPS ============
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-alb-sg'
      GroupDescription: Security group for OKR Tracker ALB
      VpcId: vpc-02d9aa88a126eabe8
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP access
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS access
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-alb-sg'
        - Key: account_env
          Value: nprd
        - Key: lob_division
          Value: ma_cng
        - Key: application
          Value: okr-tracker
        - Key: environment
          Value: dev
        - Key: owner
          Value: keith.berry@moodys.com
        - Key: provisioned_by
          Value: berryk

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-ec2-sg'
      GroupDescription: Security group for OKR Tracker EC2
      VpcId: vpc-02d9aa88a126eabe8
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP from ALB
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-ec2-sg'
        - Key: account_env
          Value: nprd
        - Key: lob_division
          Value: ma_cng
        - Key: application
          Value: okr-tracker
        - Key: environment
          Value: dev
        - Key: owner
          Value: keith.berry@moodys.com
        - Key: provisioned_by
          Value: berryk

  # ============ APPLICATION LOAD BALANCER ============
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${AWS::StackName}-alb'
      Type: application
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - subnet-051da55f78ba09adf  # AVK_FE_TRUST_SN_1A
        - subnet-06028c9de62b25295  # AVK_FE_TRUST_SN_1B
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-alb'
        - Key: account_env
          Value: nprd
        - Key: lob_division
          Value: ma_cng
        - Key: application
          Value: okr-tracker
        - Key: environment
          Value: dev
        - Key: owner
          Value: keith.berry@moodys.com
        - Key: provisioned_by
          Value: berryk

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${AWS::StackName}-tg'
      Port: 80
      Protocol: HTTP
      VpcId: vpc-02d9aa88a126eabe8
      TargetType: instance
      HealthCheckPath: /
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Targets:
        - Id: !Ref EC2Instance
          Port: 80
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-tg'
        - Key: account_env
          Value: nprd
        - Key: lob_division
          Value: ma_cng
        - Key: application
          Value: okr-tracker
        - Key: environment
          Value: dev
        - Key: owner
          Value: keith.berry@moodys.com
        - Key: provisioned_by
          Value: berryk

  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  # ============ EC2 INSTANCE ============
  EC2Instance:
    Type: AWS::EC2::Instance
    DependsOn: BackupBucket
    Properties:
      ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref EC2InstanceProfile
      SubnetId: subnet-0ce52ca1dd923d890  # AVK_APP_TRUST_SN_1A
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 30
            VolumeType: gp3
            DeleteOnTermination: false
      Tags:
        - Key: Name
          Value: okr-tracker
        - Key: account_env
          Value: nprd
        - Key: lob_division
          Value: ma_cng
        - Key: Patch Group
          Value: linux
        - Key: patch_level
          Value: lob_ondemand
        - Key: provisioned_by
          Value: berryk
        - Key: scheduler
          Value: 24/7
        - Key: backup
          Value: none
        - Key: application
          Value: okr-tracker
        - Key: environment
          Value: dev
        - Key: owner
          Value: keith.berry@moodys.com
        - Key: revenue
          Value: n
        - Key: customer
          Value: ''
        - Key: monitoring_strategy
          Value: ''
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          exec > >(tee /var/log/user-data.log) 2>&1

          echo "Starting OKR Tracker setup..."

          # Update system
          apt-get update && apt-get upgrade -y

          # Install Docker
          curl -fsSL https://get.docker.com | sh
          usermod -aG docker ubuntu

          # Install Docker Compose
          apt-get install -y docker-compose-plugin

          # Install tools
          apt-get install -y git curl wget htop jq awscli postgresql-client

          # Install Node.js 20
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs

          # Create app directory
          mkdir -p /opt/okr-tracker
          chown ubuntu:ubuntu /opt/okr-tracker

          # Clone repository from moodysanalytics
          su - ubuntu -c "git clone https://github.com/moodysanalytics/okr-tracker.git /opt/okr-tracker"

          # Create .env file
          cd /opt/okr-tracker
          JWT_SECRET=$(openssl rand -hex 32)
          ALB_DNS="${ApplicationLoadBalancer.DNSName}"

          cat > .env <<EOF
          JWT_SECRET=$JWT_SECRET
          CORS_ORIGIN=http://$ALB_DNS
          VITE_API_URL=http://$ALB_DNS
          LLM_PROVIDER=bedrock
          AWS_REGION=${AWS::Region}
          BEDROCK_MODEL_ID=${BedrockModelId}
          DB_PASSWORD=okr_password
          BACKUP_BUCKET=${BackupBucket}
          EOF

          chown ubuntu:ubuntu .env

          # ============ BACKUP SCRIPT ============
          cat > /opt/okr-tracker/backup.sh <<'BACKUP_SCRIPT'
          #!/bin/bash
          set -e

          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="okr_backup_$TIMESTAMP.sql.gz"
          BUCKET="${BackupBucket}"
          REGION="${AWS::Region}"

          echo "[$TIMESTAMP] Starting database backup..."

          # Dump database from Docker container
          docker exec okr-tracker-db-1 pg_dump -U okr okr_tracker | gzip > /tmp/$BACKUP_FILE

          # Upload to S3
          aws s3 cp /tmp/$BACKUP_FILE s3://$BUCKET/daily/$BACKUP_FILE --region $REGION

          # Clean up local file
          rm /tmp/$BACKUP_FILE

          echo "[$TIMESTAMP] Backup uploaded to s3://$BUCKET/daily/$BACKUP_FILE"

          # Also create a "latest" copy for easy restore
          aws s3 cp s3://$BUCKET/daily/$BACKUP_FILE s3://$BUCKET/latest/okr_latest.sql.gz --region $REGION

          echo "[$TIMESTAMP] Backup complete!"
          BACKUP_SCRIPT

          chmod +x /opt/okr-tracker/backup.sh
          chown ubuntu:ubuntu /opt/okr-tracker/backup.sh

          # ============ RESTORE SCRIPT ============
          cat > /opt/okr-tracker/restore.sh <<'RESTORE_SCRIPT'
          #!/bin/bash
          set -e

          BUCKET="${BackupBucket}"
          REGION="${AWS::Region}"

          if [ -z "$1" ]; then
            echo "Usage: ./restore.sh <backup-file.sql.gz | latest>"
            echo "Example: ./restore.sh okr_backup_20260123_030000.sql.gz"
            echo "         ./restore.sh latest"
            exit 1
          fi

          if [ "$1" == "latest" ]; then
            S3_PATH="s3://$BUCKET/latest/okr_latest.sql.gz"
          else
            S3_PATH="s3://$BUCKET/daily/$1"
          fi

          echo "Downloading backup from $S3_PATH..."
          aws s3 cp $S3_PATH /tmp/restore.sql.gz --region $REGION

          echo "Restoring database..."
          gunzip -c /tmp/restore.sql.gz | docker exec -i okr-tracker-db-1 psql -U okr okr_tracker

          rm /tmp/restore.sql.gz
          echo "Restore complete!"
          RESTORE_SCRIPT

          chmod +x /opt/okr-tracker/restore.sh
          chown ubuntu:ubuntu /opt/okr-tracker/restore.sh

          # ============ CRON JOB FOR DAILY BACKUPS ============
          echo "0 3 * * * ubuntu /opt/okr-tracker/backup.sh >> /var/log/okr-backup.log 2>&1" > /etc/cron.d/okr-backup
          chmod 644 /etc/cron.d/okr-backup

          # ============ START APPLICATION ============
          su - ubuntu -c "cd /opt/okr-tracker && docker compose -f docker-compose.aws.yml up -d"

          # Wait for services
          sleep 30

          # Initialize database
          su - ubuntu -c "cd /opt/okr-tracker && docker compose -f docker-compose.aws.yml exec -T backend npx prisma db push" || true
          su - ubuntu -c "cd /opt/okr-tracker && docker compose -f docker-compose.aws.yml exec -T backend npx prisma db seed" || true

          # Run initial backup
          /opt/okr-tracker/backup.sh || true

          echo "OKR Tracker setup complete with S3 backups enabled!"

Outputs:
  InstanceId:
    Description: EC2 Instance ID
    Value: !Ref EC2Instance

  ALBDNSName:
    Description: ALB DNS Name
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  WebURL:
    Description: URL to access OKR Tracker
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'

  SSMConnect:
    Description: Connect via Session Manager (no SSH key needed)
    Value: !Sub 'aws ssm start-session --target ${EC2Instance} --region ${AWS::Region}'

  BackupBucket:
    Description: S3 bucket for database backups
    Value: !Ref BackupBucket

  BackupCommand:
    Description: Manual backup command
    Value: '/opt/okr-tracker/backup.sh'

  RestoreCommand:
    Description: Restore from latest backup
    Value: '/opt/okr-tracker/restore.sh latest'

  ListBackups:
    Description: List available backups
    Value: !Sub 'aws s3 ls s3://${BackupBucket}/daily/ --region ${AWS::Region}'

  DemoCredentials:
    Description: Demo login credentials
    Value: 'Email: ceo@demo.com | Password: demo123'
